<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Frontend, Mobile, Nodejs, Life Essays, etc."><title>DCloud 个推总结 | Poeticlife</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/3.0.3/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">DCloud 个推总结</h1><a id="logo" href="/.">Poeticlife</a><p class="description">大知闲闲，小知间间；大言炎炎，小言詹詹</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/categories/Tech/"><i class="fa fa-wrench"> 技术</i></a><a href="/categories/Essays/"><i class="fa fa-pencil"> 随笔</i></a><a href="/categories/works/"><i class="fa fa-briefcase"> 作品</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">DCloud 个推总结</h1><div class="post-meta">Jan 13, 2018<span> | </span><span class="category"><a href="/categories/Tech/">Tech</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2018/01/13/Dcloud-个推总结/" href="/2018/01/13/Dcloud-个推总结/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>最近公司有用 DCloud 的产品来开发 app 里面涉及到一些问题听我细细道来。<br>推送使用的是个推平台，参见<a href="http://getui.com/cn/index.html" target="_blank" rel="external">官网</a>。这里分为<a href="http://docs.getui.com/getui/more/plugin/" target="_blank" rel="external">客户端</a>和<a href="http://docs.getui.com/getui/more/plugin/" target="_blank" rel="external">服务端</a>。DCloud的HBuilder里面有集成推送的 sdk。</p>
<p>推送的步骤可参见官方<a href="http://ask.dcloud.net.cn/article/34" target="_blank" rel="external">文档</a>。<br>大致的推送流程是：服务端发送推送 -&gt; 个推平台会进行处理 -&gt; App 的个推进程收到推送信息 -&gt; App进行消息处理和推送事件的监听。</p>
<p>这里主要遇到的问题有如下：</p>
<ul>
<li><p>应该采用何种模板才能够让 ios 和 android 客户端都可以收到推送？</p>
<p>这里只能采用透传模板TransmissionTemplate，查看个推官方 <a href="http://docs.getui.com/question/getui/ios/" target="_blank" rel="external">FAQ</a></p>
</li>
<li><p>关于离线的信息的推送，android和ios应该如何处理？</p>
<p>关于android的离线处理，我询问了安卓的小伙伴，得到的答复是无法保证离线状态下android可以收到推送。ios则可以通aps苹果推送服务来得到推送信息。</p>
<p>这里有一个地方需要注意的是服务端在发送ios离线信息的时候需要在<code>customMsg</code>参数下添加传递到客户端的参数比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">let payload = new APNPayload();</div><div class="line">let alertMsg = new SimpleAlertMsg();</div><div class="line">alertMsg.alertMsg=&quot;&quot;;</div><div class="line">payload.alertMsg = alertMsg;</div><div class="line">payload.badge=5;</div><div class="line">payload.contentAvailable =1;</div><div class="line">payload.category=&quot;&quot;;</div><div class="line">payload.sound=&quot;&quot;;</div><div class="line">payload.customMsg.body = &quot;rolman&quot;;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>  ios当app在线的时候会通过<code>receive</code>事件创建消息到消息中心，若离线则通过苹果aps推送到消息中心。</p>
<p>  <strong>需要注意的是：ios的消息展示方式，这里统一为不管app是在前台还是后台都是把推送消息显示在消息中心，这样就和android的信息展示方式统一。</strong></p>
<ul>
<li><p>在 ios app 登记的时候必须是苹果推服务证书！否则无法通过 aps 接收推送信息。</p>
<p> 查看<a href="http://docs.getui.com/question/getui/ios/" target="_blank" rel="external">这里</a>，客户端看下 devicetoken 是否有获取到，获取到了，应用配置里面上传证书的地方有个测试一下，测试看看返回什么结果，返回测试可用才说明证书环境是一致的。</p>
</li>
<li><p>关于角标的处理</p>
<p>　app 角标的处理是个比较复杂的问题，考虑的问题会比较多，这里只做了简单的处理：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"> document.addEventListener(&apos;newintent&apos;, function () &#123;</div><div class="line">	plus.runtime.setBadgeNumber(0);</div><div class="line">&#125;, false);</div><div class="line">    </div><div class="line">document.addEventListener(&apos;resume&apos;, function () &#123;</div><div class="line">	plus.runtime.setBadgeNumber(0);</div><div class="line">&#125;, false);</div><div class="line">    </div><div class="line">document.addEventListener(&apos;foreground&apos;, function () &#123;</div><div class="line">	plus.runtime.setBadgeNumber(0);</div><div class="line">&#125;, false);</div></pre></td></tr></table></figure>
<p>　</p>
</li>
<li><p>在<code>receive</code>事件中接收到的参数问题</p>
<p>在<code>receive</code>事件中传过来的参数<code>ios</code>和<code>android</code>接收到的数据类型会不一致。就是那个<code>msg.payload</code>这个参数即<code>transmissionContent</code>，ios解析为object，android解析为string。
　</p>
</li>
<li>ios 在<code>receive</code>事件中必须区分是本地消息还是服务器推送的消息否则会一直循环创建消息。</li>
</ul>
<p>消息处理的代码必须写在 HBuilder 的 manifest.json 文件中的页面入口页面中。</p>
<p>下面列出消息处理的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">$.plusReady(function() &#123;</div><div class="line">    document.addEventListener(&apos;newintent&apos;, function () &#123;</div><div class="line">    	plus.runtime.setBadgeNumber(0);</div><div class="line">    &#125;, false);</div><div class="line">    </div><div class="line">    document.addEventListener(&apos;resume&apos;, function () &#123;</div><div class="line">    	plus.runtime.setBadgeNumber(0);</div><div class="line">    &#125;, false);</div><div class="line">    </div><div class="line">    document.addEventListener(&apos;foreground&apos;, function () &#123;</div><div class="line">    	plus.runtime.setBadgeNumber(0);</div><div class="line">    &#125;, false);</div><div class="line"></div><div class="line">    // 监听在线消息事件</div><div class="line">    // ios 和 android 传过来的 msg.payload，ios 解析为 object，android 解析为 string</div><div class="line">	plus.push.addEventListener(&apos;receive&apos;, function( msg ) &#123;</div><div class="line">	   var payload = (typeof msg.payload == &apos;string&apos; ?</div><div class="line">								       JSON.parse(msg.payload) : msg.payload);</div><div class="line"></div><div class="line"></div><div class="line">		// 判断是否 ios</div><div class="line">		if ($.os.ios) &#123;</div><div class="line">			// 只有当不是本地消息的时候才创建</div><div class="line">			if (!payload._isLocal) &#123;</div><div class="line">				payload._isLocal = true;</div><div class="line">				msg.payload = payload;</div><div class="line">				plus.push.createMessage(payload.body, JSON.stringify(payload), &#123;</div><div class="line">					 title: payload.title,</div><div class="line">					 cover: false</div><div class="line">				&#125;);</div><div class="line">			&#125;</div><div class="line">		&#125; else &#123;</div><div class="line">			plus.push.createMessage(payload.body, msg.payload, &#123;</div><div class="line">				 title: payload.title,</div><div class="line">				 cover: false</div><div class="line">			&#125;);</div><div class="line">		&#125;</div><div class="line">	&#125;, false);</div><div class="line"></div><div class="line">	// 监听在消息通知点击，这里写具体的跳转业务</div><div class="line">	plus.push.addEventListener(&apos;click&apos;, function( msg ) &#123;</div><div class="line">		var payload = (typeof msg.payload == &apos;string&apos; ? JSON.parse(msg.payload) : msg.payload),</div><div class="line">		  type = payload.type,</div><div class="line">		  openUrl;</div><div class="line"></div><div class="line">	&#125;, false);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这里在进行调试的时候需要考虑蛮多的东西，多去查查个推平台的文档，然后自己可以在本地起个 nodejs 服务器，然后那个苹果的推服务的证书也得测试于是。这样就可以解决问题。</p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>这里安卓的离线的消息通知仍然有些问题，关于透传的标准格式会不会触发 click 事件，这里有个<a href="http://ask.dcloud.net.cn/article/836" target="_blank" rel="external">帖子</a>。<br>还有另一个问题就是关于角标的处理，安卓是不是也可以设置？还有如何根据业务，比如当用户读取消息再让角标减少？</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2018/01/13/Dcloud-个推总结/" data-id="cjjrzpcv9001kgdkl964kndxe" class="article-share-link">分享到</a><div class="tags"><a href="/tags/app/">app</a><a href="/tags/mui/">mui</a><a href="/tags/hybrid/">hybrid</a></div><div class="post-nav"><a href="/2018/02/08/babel-runtime-babel-preset-env-babel-plugin-transform-runtime-babel-polyfill-详解/" class="pre">babel-runtime, babel-preset-env, babel-plugin-transform-runtime, babel-polyfill 详解</a><a href="/2017/12/21/任务，微任务，队列，计划/" class="next">任务，微任务，队列，计划</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'troland';
var disqus_identifier = '2018/01/13/Dcloud-个推总结/';
var disqus_title = 'DCloud 个推总结';
var disqus_url = 'http://yoursite.com/2018/01/13/Dcloud-个推总结/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/favicon.ico',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//troland.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Backend/">Backend</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Essays/">Essays</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/FrontEnd/">FrontEnd</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tech/">Tech</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Tech/FrontEnd/">FrontEnd</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tech/Source/">Source</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/backend/">backend</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/">随笔</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/Essays/">Essays</a></li></ul></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/app/" style="font-size: 15px;">app</a> <a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/FrontEnd/" style="font-size: 15px;">FrontEnd</a> <a href="/tags/Nodejs/" style="font-size: 15px;">Nodejs</a> <a href="/tags/css3/" style="font-size: 15px;">css3</a> <a href="/tags/Mobile/" style="font-size: 15px;">Mobile</a> <a href="/tags/affix/" style="font-size: 15px;">affix</a> <a href="/tags/jQuery/" style="font-size: 15px;">jQuery</a> <a href="/tags/scrollSpy/" style="font-size: 15px;">scrollSpy</a> <a href="/tags/offset/" style="font-size: 15px;">offset</a> <a href="/tags/position/" style="font-size: 15px;">position</a> <a href="/tags/Dom/" style="font-size: 15px;">Dom</a> <a href="/tags/CurrentTarget/" style="font-size: 15px;">CurrentTarget</a> <a href="/tags/Hoisting/" style="font-size: 15px;">Hoisting</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a> <a href="/tags/express/" style="font-size: 15px;">express</a> <a href="/tags/ES6/" style="font-size: 15px;">ES6</a> <a href="/tags/mui/" style="font-size: 15px;">mui</a> <a href="/tags/hybrid/" style="font-size: 15px;">hybrid</a> <a href="/tags/token/" style="font-size: 15px;">token</a> <a href="/tags/jwt/" style="font-size: 15px;">jwt</a> <a href="/tags/jsonwebtoken/" style="font-size: 15px;">jsonwebtoken</a> <a href="/tags/babel/" style="font-size: 15px;">babel</a> <a href="/tags/viewport/" style="font-size: 15px;">viewport</a> <a href="/tags/pageYOffset/" style="font-size: 15px;">pageYOffset</a> <a href="/tags/Design-Pattern/" style="font-size: 15px;">Design Pattern</a> <a href="/tags/Event-Proxy/" style="font-size: 15px;">Event Proxy</a> <a href="/tags/microtask/" style="font-size: 15px;">microtask</a> <a href="/tags/task/" style="font-size: 15px;">task</a> <a href="/tags/event-loop/" style="font-size: 15px;">event loop</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/生活/" style="font-size: 15px;">生活</a> <a href="/tags/人生感悟/" style="font-size: 15px;">人生感悟</a> <a href="/tags/fixed/" style="font-size: 15px;">fixed</a> <a href="/tags/animate/" style="font-size: 15px;">animate</a> <a href="/tags/愉快生活/" style="font-size: 15px;">愉快生活</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/02/08/babel-runtime-babel-preset-env-babel-plugin-transform-runtime-babel-polyfill-详解/">babel-runtime, babel-preset-env, babel-plugin-transform-runtime, babel-polyfill 详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/13/Dcloud-个推总结/">DCloud 个推总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/21/任务，微任务，队列，计划/">任务，微任务，队列，计划</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/16/第五种定位属性/">第五种定位属性</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/09/常用-Git-命令及工作流/">常用 Git 命令及工作流</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/04/两种视口的故事系列之二/">两种视口的故事系列之二</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/03/两种视窗的故事系列之一/">两种视口的故事系列之一</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/19/事件委托，事件代理，发布者订阅者模式/">事件委托，事件代理，发布者订阅者模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/12/动画收集/">动画收集</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/28/DOM相关/">DOM相关</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//troland.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.w.com/" title="医方" target="_blank">医方</a><ul></ul><a href="https://github.com/Troland" title="我的Github" target="_blank">我的Github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Poeticlife.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>